---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// 1. Generar rutas estáticas
export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// 2. Obtener datos y renderizar contenido
const { post } = Astro.props;
const { Content } = await render(post);

const formattedDate = post.data.publishedAt.toLocaleDateString('es-ES', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
});
---

<BaseLayout title={`${post.data.title} | Diario de Escritura`}>
  
  <div class="fixed top-0 left-0 w-full h-1.5 bg-transparent z-[200]">
    <div class="h-full bg-dusty-rose w-0 transition-all duration-100 ease-out shadow-[0_0_10px_rgba(226,209,195,0.7)]" id="progress-bar"></div>
  </div>

  <article class="pt-32 pb-32 px-6 min-h-screen">
    
    <header class="max-w-4xl mx-auto text-center mb-16 reveal">
        
        <a href="/#blog" class="inline-flex items-center text-xs font-bold tracking-widest uppercase text-ink/40 hover:text-ink mb-10 transition-colors cursor-pointer z-10 relative">
            &larr; Volver al Diario
        </a>
        
        <time class="block text-sage font-sans font-bold text-xs tracking-[0.3em] uppercase mb-6">
            {formattedDate}
        </time>
        
        <h1 class="font-serif text-4xl md:text-6xl text-ink leading-[1.1] mb-10 text-balance">
            {post.data.title}
        </h1>

        {post.data.image && (
            <div class="relative w-full aspect-video rounded-sm overflow-hidden shadow-xl mt-8 bg-paper">
                <img 
                    src={post.data.image} 
                    alt={post.data.title} 
                    class="w-full h-full object-cover"
                    transition:name={`blog-img-${post.slug}`}
                />
            </div>
        )}
    </header>

    <div class="reveal delay-100 max-w-2xl mx-auto prose prose-lg prose-stone 
                prose-headings:font-serif prose-headings:font-normal prose-headings:text-ink
                prose-p:font-sans prose-p:font-light prose-p:text-ink/80 prose-p:leading-loose
                prose-a:text-dusty-rose prose-a:no-underline hover:prose-a:text-sage prose-a:transition-colors
                prose-blockquote:border-l-dusty-rose prose-blockquote:italic prose-blockquote:text-sage prose-blockquote:bg-ink/5 prose-blockquote:py-2 prose-blockquote:pr-4
                prose-strong:font-bold prose-strong:text-ink">
        <Content />
    </div>
    
    <div class="max-w-2xl mx-auto mt-16 pt-10 border-t border-ink/10 text-center reveal delay-200">
        <p class="font-serif italic text-ink/40 text-xl">Gracias por leer.</p>
        <a href="/#blog" class="inline-block mt-4 text-xs font-bold uppercase tracking-widest text-dusty-rose hover:text-sage transition-colors">
            Leer otro artículo
        </a>
    </div>

  </article>

  <script>
    document.addEventListener('astro:page-load', () => {
        const bar = document.getElementById("progress-bar");
        
        const updateProgress = () => {
            if (!bar) return;
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            bar.style.width = scrolled + "%";
        };

        window.removeEventListener('scroll', updateProgress); // Limpieza
        window.addEventListener('scroll', updateProgress);
    });
  </script>
</BaseLayout>
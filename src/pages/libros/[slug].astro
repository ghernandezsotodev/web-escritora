---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// 1. Generar rutas
export async function getStaticPaths() {
  const books = await getCollection('books');
  return books.map(book => ({
    params: { slug: book.slug },
    props: { book },
  }));
}

// 2. Obtener datos
const { book } = Astro.props;
const { Content } = await render(book);

// 3. Lógica visual
const isNovela = book.data.category === 'novela';
const formattedDate = book.data.publishedAt.toLocaleDateString('es-ES', { year: 'numeric', month: 'long' });
---

<BaseLayout title={`${book.data.title} | María Esperanza Gallegos`}>
  
  <article class="min-h-screen pt-32 pb-24">
    
    <div class="max-w-6xl mx-auto px-6 grid md:grid-cols-12 gap-12 mb-20">
      
      <div class="md:col-span-5 lg:col-span-4 relative">
        <div class="sticky top-32 reveal">
            <a href="/#libros" class="inline-flex items-center text-xs font-bold tracking-widest uppercase text-ink/40 hover:text-ink mb-8 transition-colors">
                &larr; Volver a la biblioteca
            </a>

            <div class={`relative w-full shadow-2xl ${isNovela ? 'aspect-[2/3] rounded-sm' : 'aspect-[3/4] rounded-xl'} overflow-hidden bg-paper`}>
                <img 
                    src={book.data.cover} 
                    alt={`Portada de ${book.data.title}`} 
                    class="w-full h-full object-cover"
                    transition:name={`book-cover-${book.slug}`} 
                />
            </div>
            
            <div class="mt-6 border-t border-ink/10 pt-4 flex justify-between text-xs font-sans text-ink/60 uppercase tracking-wider">
                <span>{book.data.category}</span>
                <span>{formattedDate}</span>
            </div>

            <div class="md:hidden mt-8 text-center">
                {book.data.buyLink && (
                    <a href={book.data.buyLink} target="_blank" rel="noopener noreferrer" class="inline-block w-full py-4 bg-ink text-paper font-sans font-bold uppercase tracking-widest text-sm hover:bg-dusty-rose hover:text-ink transition-colors">
                        Comprar Libro
                    </a>
                )}
            </div>
        </div>
      </div>

      <div class="md:col-span-7 lg:col-span-7 flex flex-col justify-center">
        
        <div class="reveal delay-100">
            <h1 class="font-serif text-5xl md:text-7xl text-ink leading-[1] mb-6">
                {book.data.title}
            </h1>
            
            {book.data.subtitle && (
                <p class="font-serif text-2xl md:text-3xl text-ink/60 italic mb-10 border-l-4 border-dusty-rose pl-6">
                    {book.data.subtitle}
                </p>
            )}

            {book.data.buyLink ? (
                <a href={book.data.buyLink} target="_blank" rel="noopener noreferrer" class="hidden md:inline-block px-10 py-4 bg-ink text-paper font-sans font-bold uppercase tracking-widest text-xs hover:bg-dusty-rose hover:text-ink transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1">
                    Adquirir Ejemplar
                </a>
            ) : (
                 <a href={`mailto:contacto@mariaesperanzagallegos.com?subject=Consulta sobre ${book.data.title}`} class="hidden md:inline-block px-10 py-4 border border-ink/20 text-ink font-sans font-bold uppercase tracking-widest text-xs hover:bg-sage/20 transition-all cursor-pointer">
                    Consultar Disponibilidad
                </a>
            )}
        </div>

      </div>
    </div>

    <div class="max-w-3xl mx-auto px-6 reveal delay-200">
        <div class="prose prose-lg prose-stone max-w-none 
                    prose-headings:font-serif prose-headings:font-normal prose-headings:text-ink
                    prose-p:font-sans prose-p:font-light prose-p:text-ink/80 prose-p:leading-relaxed
                    prose-blockquote:border-l-dusty-rose prose-blockquote:italic prose-blockquote:text-sage
                    prose-a:text-dusty-rose hover:prose-a:text-sage prose-a:transition-colors">
            
            <span class="block text-sage font-bold text-xs uppercase tracking-widest mb-8 border-b border-ink/10 pb-2">
                Sinopsis & Detalles
            </span>
            
            <Content />
        </div>
    </div>

  </article>

</BaseLayout>